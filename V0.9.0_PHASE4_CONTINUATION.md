# Phase 4 Continuation Prompt - Plugin System v0.9.0

**Context**: Phase 3 (Todoist integration) is complete and ready for PR. This prompt guides the next session to verify the PR and begin Phase 4 enhancements.

---

## ğŸ“‹ Session Start Checklist

Hi! I'm continuing work on the _pyrite plugin system v0.9.0. Here's where we left off:

### Phase 3 Status
- **Branch**: `claude/plugin-base-classes-HdCgf`
- **Status**: âœ… Production ready, all tests passing
- **PR**: Ready to create or verify if already created

### Please start by:

1. **Check if PR exists**
   ```bash
   gh pr list --head claude/plugin-base-classes-HdCgf
   ```

2. **If PR exists**, verify it and check status:
   ```bash
   gh pr view <PR-NUMBER>
   ```

3. **If PR doesn't exist**, create it:
   ```bash
   gh pr create \
     --title "feat: Plugin System v0.9.0 - Phases 2 & 3 (Todoist Integration)" \
     --body-file PHASE_3_SUMMARY.md \
     --base main \
     --head claude/plugin-base-classes-HdCgf
   ```

4. **Read the context documents**:
   - `FINAL_RECAP_PHASE3.md` - Complete recap of what was built
   - `PHASE_3_SUMMARY.md` - PR summary
   - `plugins/todoist/README.md` - Todoist plugin documentation

5. **Verify all tests still pass**:
   ```bash
   python test_plugins.py   # Should be 6/6 passing
   python test_todoist.py   # Should be 8/8 passing
   ```

---

## ğŸ¯ Phase 4 Goals

Once PR is verified/created, implement these architectural improvements:

### 1. Work Effort Lookup & Linking

**Current behavior**:
- Every Todoist task with 'pyrite' label creates a NEW work effort

**Desired behavior**:
- Check if task references an existing WE first
- Parse `WE-YYMMDD-xxxx` from task description
- If found, link to that WE instead of creating new one
- If not found, create new WE as before

**Implementation**:
```python
# In TodoistPlugin.create_work_effort()

# 1. Check task description for WE-YYMMDD-xxxx pattern
we_match = re.search(r'WE-\d{6}-[a-z0-9]{4}', task.description)

if we_match:
    # Link to existing work effort
    we_id = we_match.group(0)
    we_path = find_work_effort(we_id)
    if we_path.exists():
        return link_to_existing_we(task, we_path)

# 2. If no match, create new WE (current behavior)
we_id = generate_we_id()
# ... existing creation logic
```

### 2. Subtask â†’ Ticket Mapping

**Current behavior**:
- Only the main task is processed
- Subtasks are ignored

**Desired behavior**:
- Main task â†’ work effort (existing or new)
- Each subtask â†’ ticket in `tickets/` directory

**Example**:
```
Todoist:
â˜ Build auth system [pyrite] WE-260102-auth
  â˜ Create login form
  â˜ Add password reset
  â˜ Implement OAuth

â†’ Creates:
_work_efforts/WE-260102-auth_authentication_system/
  tickets/
    TKT-auth-001_create_login_form.md
    TKT-auth-002_add_password_reset.md
    TKT-auth-003_implement_oauth.md
```

**API Support**:
```python
# Todoist API v2 doesn't directly support subtasks
# But we can parse them from the task content

def parse_subtasks(task_content: str) -> List[str]:
    """
    Parse markdown checklist from task content
    - [ ] Item 1
    - [ ] Item 2
    """
    lines = task_content.split('\n')
    subtasks = []
    for line in lines:
        if re.match(r'^\s*-\s*\[\s*\]\s*(.+)$', line):
            subtasks.append(line)
    return subtasks
```

### 3. Multiple Tasks â†’ One Work Effort

**Scenario**:
```
Todoist Task 1: "Frontend auth UI" [pyrite] WE-260102-auth
  â˜ Login form
  â˜ Signup form

Todoist Task 2: "Backend auth API" [pyrite] WE-260102-auth
  â˜ JWT middleware
  â˜ Password hashing
```

Both should add tickets to `WE-260102-auth`

**Implementation**:
- Use WE-ID lookup from #1
- Both tasks find same WE
- Both create tickets in same `tickets/` directory
- Track which Todoist tasks contributed (in frontmatter)

### 4. Enhanced Feedback

**Current feedback**:
```markdown
âœ… Work Effort Created!
ğŸ“ Folder: WE-260102-auth_authentication_system
ğŸ“‹ Index: WE-260102-auth_index.md
ğŸ« Tickets: tickets/
```

**Enhanced feedback**:
```markdown
âœ… Linked to Work Effort: WE-260102-auth

ğŸ“ **Folder**: WE-260102-auth_authentication_system
ğŸ“‹ **Index**: WE-260102-auth_index.md

ğŸ« **Tickets Created**:
- TKT-auth-001_create_login_form.md
- TKT-auth-002_add_password_reset.md
- TKT-auth-003_implement_oauth.md

You can now track progress in the _pyrite system!
```

---

## ğŸ› ï¸ Implementation Plan

### Step 1: WE Lookup System
- Create `find_work_effort(we_id: str) -> Optional[Path]`
- Parse WE-ID from task description
- Check if WE exists before creating new

### Step 2: Subtask Parser
- Create `parse_subtasks(task: ExternalTask) -> List[str]`
- Parse markdown checklist from task description
- Generate ticket IDs (TKT-xxxx-NNN format)

### Step 3: Ticket Creator
- Create `create_ticket(we_path: Path, title: str, description: str) -> Path`
- Use existing ticket naming conventions
- Add frontmatter with Todoist task ID reference

### Step 4: Enhanced Feedback
- Update `_format_feedback_message()` to include ticket list
- Show which tickets were created
- Include WE status (new vs linked)

### Step 5: Testing
- Add tests for WE lookup
- Add tests for subtask parsing
- Add tests for ticket creation
- Add tests for multiple tasks â†’ one WE
- Update existing tests as needed

---

## ğŸ“ Key Files to Modify

1. **`plugins/todoist/plugin.py`**
   - Add `find_work_effort()` method
   - Add `parse_subtasks()` method
   - Add `create_ticket()` method
   - Update `create_work_effort()` to check for existing WE
   - Update `_format_feedback_message()` for enhanced output

2. **`plugins/helpers.py`**
   - Add `find_work_effort_by_id(base_path: Path, we_id: str) -> Optional[Path]`
   - Add ticket naming utilities

3. **`test_todoist.py`**
   - Add tests for new functionality
   - Update existing tests if needed

4. **`plugins/todoist/README.md`**
   - Document new features
   - Update examples
   - Add troubleshooting for linking

---

## ğŸ§ª Testing Strategy

### Manual Testing with Real Todoist

1. **Test WE Linking**:
   - Create WE manually: `WE-260102-test`
   - Create Todoist task with `WE-260102-test` in description
   - Add 'pyrite' label
   - Run plugin, verify it links (doesn't create new WE)

2. **Test Subtasks**:
   - Create Todoist task with checklist:
     ```
     Build feature [pyrite] WE-260102-feat
     - [ ] Step 1
     - [ ] Step 2
     - [ ] Step 3
     ```
   - Run plugin, verify 3 tickets created

3. **Test Multiple Tasks â†’ One WE**:
   - Create 2 Todoist tasks, both with `WE-260102-multi`
   - Both have different subtasks
   - Run plugin, verify all tickets in same WE

---

## ğŸ¯ Success Criteria

Phase 4 is complete when:

- âœ… Plugin checks for existing WE before creating new
- âœ… WE-ID can be parsed from task description
- âœ… Subtasks are converted to tickets
- âœ… Multiple tasks can contribute to same WE
- âœ… Enhanced feedback shows created tickets
- âœ… All tests passing (existing + new)
- âœ… Documentation updated
- âœ… Real-world testing with Todoist completed

---

## ğŸ“š Reference

### Current Architecture (Phase 3)
```
Todoist task + 'pyrite' label
  â†’ fetch_tasks()
  â†’ create_work_effort() [ALWAYS creates new]
  â†’ post_feedback()
  â†’ cleanup()
```

### New Architecture (Phase 4)
```
Todoist task + 'pyrite' label
  â†’ fetch_tasks()
  â†’ check for WE-ID in description
      â†“ found              â†“ not found
  link_to_existing()   create_new_we()
      â†“                    â†“
  parse_subtasks()
      â†“
  create_tickets()
      â†“
  post_enhanced_feedback()
      â†“
  cleanup()
```

---

## ğŸš€ Quick Start for This Session

```bash
# 1. Check PR status
gh pr list --head claude/plugin-base-classes-HdCgf

# 2. If no PR exists, create it
gh pr create --title "feat: Plugin System v0.9.0 - Phases 2 & 3" \
  --body-file PHASE_3_SUMMARY.md

# 3. Read the recap
cat FINAL_RECAP_PHASE3.md

# 4. Verify tests
python test_plugins.py && python test_todoist.py

# 5. Create new branch for Phase 4
git checkout main
git pull
git checkout -b claude/plugin-phase4-enhancements-$(date +%s)

# 6. Begin implementing Phase 4 features
# Start with WE lookup, then subtasks, then enhanced feedback
```

---

## ğŸ¤ User Context

The user has shared these real-world use cases:

### Domains/Projects
- johnnyautoseed.com
- porchroot.com
- survivingthesingularity.com
- chicofl.org
- treasuretavernhq.com
- escapecapitalism.org
- porchroot.substack.com
- foltechnica.io

### Goals
- YouTube content creation (primary focus)
- Email newsletter
- Marketing for Chico Fab Lab
- Building in public / documenting journey
- "Shouse" build workshop project

### Workflow Needs
- Manage multiple projects that may share work efforts
- Track tasks across different initiatives
- Build content pipeline for YouTube
- Quick task â†’ WE conversion from Todoist
- Subtasks should become actionable tickets

The user wants this to be a **real tool they use daily**, not just a demo. The Phase 4 enhancements directly support their workflow of managing multiple projects with shared work efforts.

---

## âœ… Ready to Start

Once you've verified the PR status and read the context, let me know and we'll begin implementing Phase 4 enhancements!

**Current Status**: Phase 3 complete, tests passing, ready for PR
**Next**: Verify PR, then implement Phase 4 features
**Goal**: Make this tool production-ready for real daily use
